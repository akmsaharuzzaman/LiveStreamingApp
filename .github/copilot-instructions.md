# DL Star - Copilot Instructions

## Project Overview
**DL Star** is a Flutter live streaming application with clean architecture, real-time messaging, video editing, and social features. Built with BLoC state management, dependency injection (GetIt/Injectable), and Go Router navigation.

---

## Architecture Pattern

### Clean Architecture with Three Layers
```
feature/
├── data/           # Repositories (impl), Models (JSON serialization), DataSources (API/Local)
├── domain/         # Entities, abstract Repositories, UseCases
└── presentation/   # BLoC (events/states), Pages, Widgets
```

- **Domain**: Business logic - returns `Either<Failure, T>` from usecases
- **Data**: API calls (Dio) & local storage (SharedPreferences)
- **Presentation**: UI with BLoC event/state pattern

### Key Pattern Examples
- **UseCase** structure: Takes repository, returns `Future<Either<Failure, Entity>>` (see `lib/features/home/domain/usecases/get_counter.dart`)
- **Models**: Extend `Equatable`, implement `fromJson()` & `toJson()` manually (see `lib/features/chat/data/models/chat_models.dart` - NOT using `@JsonSerializable`)
- **Repositories**: Abstract in domain, concrete impl in data with DI via `@injectable` (see `lib/features/reels/domain/repositories/reels_repository.dart`)

---

## State Management: BLoC Pattern

### Event-Driven Architecture
```dart
// Events - user actions
abstract class ChatEvent extends Equatable { }
class LoadConversationsEvent extends ChatEvent { }

// States - UI reflects these
abstract class ChatState extends Equatable { }
class ChatLoading extends ChatState { }
class ChatConversationsLoaded extends ChatState {
  final List<Conversation> conversations;
}

// BLoC - handles business logic
@injectable
class ChatBloc extends Bloc<ChatEvent, ChatState> {
  ChatBloc(this._service, this._authBloc) : super(const ChatInitial()) {
    on<LoadConversationsEvent>(_onLoadConversations);
  }
}
```

**Pattern**: Always use `fold()` on `Either` type to handle success/failure (see `lib/features/chat/presentation/bloc/chat_bloc.dart` lines 100-120).

---

## Dependency Injection (DI)

### Setup
- **Entry point**: `lib/injection/injection.dart` - calls `configureDependencies()`
- **Auto-generated**: `lib/injection/injection.config.dart` - generated by `injectable` package
- **Registration**: Use `@injectable` annotation on constructors

```dart
// In main.dart
await configureDependencies();
BlocProvider<ChatBloc>(create: (context) => getIt<ChatBloc>())
```

**Command**: `flutter packages pub run build_runner build` (regenerates DI graph)

---

## Real-Time Communication

### WebSockets (Socket.io)
- Located: `lib/core/network/socket_service.dart`
- Used for: Live chat, real-time notifications
- Pattern: Emits events to listeners; integrate with BLoC for UI updates

### Agora SDK
- Real-time video/audio (live streaming, calls)
- Permissions managed via `permission_handler` package
- Screen sleep prevented via `wakelock_plus`

---

## HTTP & Networking

### Dio Configuration
- **Client**: `lib/core/network/dio_client.dart` - configures timeouts, headers, auth token
- **Auth Token**: Auto-injected from SharedPreferences as `Bearer $token`
- **Base URL**: `DataConstants.baseUrl` (currently `http://31.97.222.97:8000`)

### API Services
- Pattern: Service class methods return `Either<String, T>` (error message or data)
- Example: `lib/features/chat/data/services/chat_api_service.dart`

---

## Code Generation Pipeline

### Required Commands
```bash
# Generate all (usecases, models, DI)
flutter packages pub run build_runner build

# Watch for changes during development
flutter packages pub run build_runner watch

# Clean generated files
flutter packages pub run build_runner clean
```

**Triggers**: Changes to files with `@injectable`, `@JsonSerializable` annotations.

---

## Authentication & Security

### Firebase Integration
- Setup: `lib/firebase_options.dart` (auto-generated)
- Auth BLoC: `lib/core/auth/auth_bloc.dart` - manages login, logout, profile states
- Token Storage: SharedPreferences key `'auth_token'` (see `lib/core/network/dio_client.dart`)

### States
- `AuthInitial` → `AuthLoading` → `AuthAuthenticated` or `AuthProfileIncomplete` → `AuthUnauthenticated`

---

## Routing with Go Router

### Route Structure
- Centralized: `lib/routing/app_router.dart`
- Initial route: Splash screen (`AppRoutes.splash`)
- Pattern: Use `AppRoutes` constants for all navigation

```dart
context.push(AppRoutes.chat);  // Navigate
context.pop();                  // Back
```

### Route Constants
Key routes: `splash`, `login`, `register`, `home`, `live`, `chat`, `reels`, `newsfeed`

---

## Error Handling

### Failure Hierarchy
```dart
// lib/core/errors/failures.dart
abstract class Failure extends Equatable {
  final String message;
}
class ServerFailure extends Failure { }
class CacheFailure extends Failure { }
class NetworkFailure extends Failure { }
```

**Pattern**: UseCase returns `Either<Failure, T>`, BLoC folds to emit error state with message.

---

## UI Framework

### Responsive Design
- **ScreenUtil**: Scales UI for 430x932 design size (see `main.dart`)
- Use: `h`, `w`, `.sp`, `.r` extensions for responsive sizing
- Design: Mobile-first (consider tablet/web as secondary)

### Material 3 Theme
- Light/Dark themes in `lib/core/theme/app_theme.dart`
- Colors: Primary `0xFF6750A4`, Secondary `0xFF625B71`, Error `0xFFBA1A1A`

---

## File Organization Conventions

- **Models**: Suffix `_model.dart`, inherit `Equatable`, implement `fromJson()`/`toJson()`
- **Entities**: Suffix `_entity.dart`, domain layer pure types
- **Services**: Suffix `_service.dart` or `_api_service.dart`
- **BLoCs**: File contains Events, States, BLoC class together
- **Constants**: `lib/core/constants/app_constants.dart`, split by layer (AppConstants, DataConstants, ApiConstants)

---

## Testing Approach

- Test files: `test/` directory mirrors `lib/` structure
- Not yet heavily utilized; focus on clean architecture for testability

---

## Common Development Tasks

| Task | Command |
|------|---------|
| Start dev | `flutter run` |
| Generate code | `flutter packages pub run build_runner build` |
| Watch mode | `flutter packages pub run build_runner watch` |
| Analyze | `flutter analyze` |
| Format | `dart format .` |
| Build APK | `flutter build apk` |

---

## Integration Points & Cross-Feature Communication

1. **AuthBloc** (Global): Accessed from any BLoC to check user state; injected as dependency
2. **ChatBloc & ChatDetailBloc**: Chat feature uses both; provided in `MultiBlocProvider` in main
3. **SocketService**: Singleton service; can emit events that BLoCs listen to
4. **SharedPreferences**: Used for token, user data, theme preference (see `DataConstants`)

---

## Critical Developer Notes

⚠️ **Important Patterns**
- **Never** use `@JsonSerializable` - manually implement `fromJson()` (common pattern in models)
- **Always** wrap domain logic in `Either<Failure, T>` for composable error handling
- **Always** close timers/streams in BLoC's `close()` method (see ChatBloc auto-refresh timer)
- Use **`fold()`** pattern from dartz: `result.fold((error) => ..., (data) => ...)`
- **Environment variables**: Load via `flutter_dotenv` in `main.dart` before Firebase init

⚠️ **Architecture Violations to Avoid**
- Don't call repositories directly from UI (use BLoC/UseCase)
- Don't mix layers (presentation logic in domain, API calls in presentation)
- Don't forget to register new classes with `@injectable`

---

## Features Overview

- **Chat**: Real-time messaging, auto-refresh conversations
- **Live**: Stream video with Agora SDK
- **Reels**: Short-form video with editing
- **Newsfeed**: Social feed
- **Profile**: User profile, completion flow
- **Settings**: App configuration
- **Store**: In-app shop/gifts

Each feature is self-contained with domain/data/presentation layers.
